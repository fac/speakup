<h2><%= @room.name %></h2>
<p>Participants: <%= @room.users.size %></p>
<p>Average score: <span id="score"><%= average_rating(@room) %></span></p>

<% if logged_in? %>
  <% if current_user.in_room?(@room) %>
    <%= form_for default_rating(@rating, @room) do |f| %>
      <%= f.hidden_field :room_id %>
      <%= f.label :score, 'Rating' %>
      <%= f.select :score, options_for_rating %>
      <%= f.button 'Submit score' %>
    <% end %>
  <% else %>
    <%= form_for @participation do |f| %>
      <%= f.hidden_field :room_id %>
      <%= f.button 'Join room' %>
    <% end %>
  <% end %>
<% else %>
  <p>Log in to join room</p>
<% end %>


<script>
  var scheme   = "<%= ws_scheme %>";
  var room_id = "<%= @room.id%>";
  var uri      = scheme + window.document.location.host + "/";
  console.log(uri);
  var ws       = new WebSocket(uri);

  ws.onmessage = function(message) {
    data = JSON.parse(message.data);
    console.log(data);
    if (data.message === "hello") {
      console.log("hello");
      ws.send(JSON.stringify({message: "get_scores"}));
    } else if (data.message == "scores") {
      scores = data.scores;
      $('#score').html(scores[room_id]);
    } else {
      console.log("Unrecognised message");
      console.log(data);
    }

  };
</script>
